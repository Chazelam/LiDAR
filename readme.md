# LAS_split
Разбиение файла на сектора без загрузки всего файла в память.
При разбиение сохраняется доп. информация о точках.

## Todo:
- [x] Добавить зазоры
- [ ] При разбиении без зазоров сумма файлов превосходит исходный на ~10%, найти причину
>На первый взгляд сумма заголовков не соответствует разнице

- [ ] Сейчас есть ощущение что зазоры не совсем корректно работают, провести тесты.
- [ ] Добавлять информацию о разбиение в header - Description, в частности размер и зазоры
- [ ] Параметр chunk_size не в точках, а в требуемом объеме ОЗУ
- [ ] Добавить многопоточность
- [ ] Прибраться в комментариях
  

# LAS_merge
Сейчас оставляет файл с отверстиями, такое ощущение что большие сектора не итерируются, можно попробовать загружать полностью для проверки.


# PMF filter
Перевел на векторные вычисления, ускорив работу в 60+ раз.
Исходный скрипт обрабатывал файл 40М точек больше 20 минут, новый - 26 секунд.

Исправил сохранение, изначально неверно копировались атрибуты. В новый las брались атрибуты первых n точек, а сами точки были произвольные из-за чего они мешались.
Заменил на применение маски к всему las объекту.

## Todo:
- [ ] Желательно добавить хоть какой нибудь прогресс бар
- [ ] Протестировать зависимость настроек фильтра.


# Normalization
Очень зависит от определения земли, добавляет шум, не уверен что она нам в целом нужна если мы будем отделять деревья.
  

# Density filter
Поиск количества соседей в радиусе 1 метра:
```python
counts_large = tree.query_ball_point(points, r=1, workers=-1, return_length=True)
```
18М точек на ryzen 5500 с 100% загрузгой на 12 ядер по 4.3Ghz занял 90 минут.
А это чанк 5х5 метров.
И на сервере будет проц в разы слабее -_- 

Быстрая гуглежка более оптимальных методов не дала.
Есть конечно вариант подключить GPU с CUDA, но сомнительно.

Листва в центральных облостях гораздо плотнее чем ожидал.
Сохранил количество соседей для 1, 0.1, 0.01 и 0.001 метра в файлы npy, чтобы не пересчитывать.
Провести анализ плотностей и найти комбиначию и порог для отделения листвы.

---

# Ссылки
[LAS format Specification](https://www.asprs.org/a/society/committees/standards/asprs_las_format_v12.pdf)
>Бтв устарел, уже есть [16 версия](https://github.com/user-attachments/files/19652477/LAS_1.4R16_draft_for_public_comment_v2.pdf), нужно проверить отличия 

[laspy documentation](https://laspy.readthedocs.io/en/latest/intro.html#header)
[laspy.lasappender — laspy 2.5.0 documentation](https://laspy.readthedocs.io/en/latest/_modules/laspy/lasappender.html#LasAppender)

[lasview - LAStools documentation](https://downloads.rapidlasso.de/html/lasview_README.html)
